# 网际协议 IP（Internet Protocal）

网际协议`IP`是`TCP/IP`中最重要的两个协议之一。

其作用是：屏蔽各种异构网络的异构性，使这些异构的网络能够在网络层上看起来像是一个统一的网络。

> `IP`协议是不可靠协议，也就是说`IP`协议不提供数据传送出现差错时的处理机制，这些是其上层协议要做的事。

# IP 数据报的格式

![](https://raw.githubusercontent.com/CyC2018/CS-Notes/master/notes/pics/85c05fb1-5546-4c50-9221-21f231cdc8c5.jpg)

一个协议的功能往往体现在它的首部中，`IP`也不例外。

- 版本： `4bit`，`IP`的版本，通信双方使用的版本必须一致，目前广泛使用的`IP`版本是`IPv4`，以后还有`IPv6`.
- 首部长度：`4bit`，`IP`报文首部字段的长度，最大值为`2^4 - 1 = 15`,单位是`32bit`字，所以首部最大长度为`15 * 4 = 60 byte`, 因为首部`20byte`都是固定的，所以首部长度字段最小值为`5`.
- 区分服务：`8bit`。只有在使用区分服务时才起作用，一般情况都不使用。
- 总长度：`2byte`，报文首部和数据字段之和的长度，单位是`byte`。所以`IP`数据的最大长度为`2^16 - 1byte`。因为数据链路层协议都规定了一个数据帧中的数据字段的最大长度`MTU`，如果`IP`的长度超过这个`MTU`就必须进行分片处理。
- 标识：`2byte`。当数据过长必须分片时，标识字段就会被复制到每一个分片中，相同的标识字段的值使分片能够被重新组装为原来的数据报。
- 标志：`2bit`，目前仅两位有意义：
  - MF：`more fragment`，是否还有其他分片，为 0 时表示该分片是原数据报中最后一个
  - DF：`don't fragment`，为 1 表示不能分片
    ![](https://raw.githubusercontent.com/CyC2018/CS-Notes/master/notes/pics/23ba890e-e11c-45e2-a20c-64d217f83430.png)
- 片偏移： `13bit`。和标识配合使用，它标识该分片相对于原数据报的偏移位置。单位是`8byte`，所以每个分片的长度一定是`8byte`的整数倍
- 生存时间：`TTL`，表示数据报在网络中的寿命，单位是跳数，每经过一个`router`就减一，如果在被转发之前`TTL`为 0，`router`就会丢弃这个报文。
- 协议：`8bit`。指出数据报使用何种协议，接收方应该讲此报文交付给哪个协议之用。
- 首部检验和：`16bit`。计算方法同 UDP。
- 源 IP 地址、目 IP 地址： `32bit`。
  > `IP`数据报的长短各有优点，长了效率高，但是短了`router`转发更快。分片的原因是因为目的主机有可能无法接受太长的数据。

# IP 地址

在物理层中，一般通过`MAC地址`来识别不同的结点，在网络层中对应的地址标识就是`IP地址`。`IP`地址是给互联网上的每一台主机的每一个接口分配一个全世界独一无二的*32 位标识符*。

`IP`地址有三种划分方式：

1.  分类的`IP`地址
2.  划分子网
3.  无分类编址`CIDR`

## 分类的 IP 地址

![](https://raw.githubusercontent.com/CyC2018/CS-Notes/master/notes/pics/cbf50eb8-22b4-4528-a2e7-d187143d57f7.png)
所谓分类的 IP 地址就是将 IP 地址划分为若干个固定的类。每一类地址都由两个固定长度的字段组成：

- 网络号：net-id 他是主机或路由器所连接到的网络的标识，互联网中的每个网络标识必须唯一；
- 主机号：host-id 标志该主机或路由器。一台主机号在它前面的网络号所指明的网络范围内也必须是唯一的。
  > 由此可见，IP 地址在整个互联网范围内一定是唯一的。而且它指明了主机和主机所连接到的网络。

对于主机和路由器来说，IP 地址都是 32 位常的二进制代码，为了方便阅读，将这 32 位代码 8 个一组，分为四组，每组转换为 10 进制后，在其之间用 . 间隔，这种表示法叫作：**点分十进制记法**。

### 三种常用的 IP 地址

A 类：

- net-id：A 类 IP 地址的网络号字段占**1byte**，不过第 1 位固定为 0，所以可变的只有 7 位。所以 A 类地址的网络号可指派的个数为：2^7?<br />No。因为网络号字段全为 0 是具有特殊意义的保留地址，意为：**本网络**。<br />还有，网络号字段的后 7 位全为 1，也是一个保留地址，作为本地软件环回测试。（本主机的进程之间的通信所用）。所以可指派的网络号个数为`2^7 - 2`
  > 0.0.0.0 就是本机，127._._.\*本机进程通信所用。目的地址为环回地址时，IP 数据报不会被发送到任何网络，因为 127 就不是一个网络号。
- host-id：主机号字段占**3byte**，同样的，它可以指派的主机号也不是简单的 2^24，而是`2^24 - 2`。<br>主机号全为 0，保留为本主机所连接到的单个网络地址。（举个例子，IP 为 1.2.3.4 连接到的网络地址就是 1.0.0.0）<br>而全为 1，保留为连接到本网络的所有主机。
  > A 类所占的所有 IP 地址个数为 `2^7 * 2^24 = 2^31`,占所有 IP 地址的`50%`。

B 类：

- net-id：网络号占**2byte**,前两位已经确定为 10，还有 14 位。期中 128.0.0.0 也是不指派的，所以其最小可指派的网络地址为 128.1.0.0，所以 B 类的可指派网络号有`2^14 - 1`。
- host-id：有**2byte**和 A 类一样，全 0 个全 1 被保留，所以可指派的主机号有：`2^16 - 2`
  > 整个 B 类有`2^14 * 2^16 = 2^30`个地址，占全部的`25%`。

C 类：

- net-id：网络号占**3byte**，前面三位确定为 110，2^21 - 1,192.0.0.0 是不指派的。
- host-id：有**1byte**，和上面一样全 0 全 1 干掉之后，可指派个数为：`2^8 - 2`
  > 整个 C 类有`2^21 * 2^8 = 2^29`，占全体的`12.5%`。

> 总结上面的规律，net-id 的可指派的位全为 0 时是不指派的。host-id 的全 0 和全 1 都是保留的。

### 划分子网

既然已经有了 ABCDE 类网络了，为什么还要搞个划分子网呢？昂？

因为现在看来当如 IP 地址的分类设计不太合理：

- IP 地址利用率有可能很低：A 类地址所拥有的主机数是最多的，就导致如果一个单位申请了一个 A 或者 B，但其实这个单位的主机并不多，就导致很多 IP 地址浪费了。但是这些人又不愿意申请够用的 C 类。
- 给每个物理网络分配一个 net_id 会导致路由表异常巨大，需要更多的空间去存储、更长的时间去查找，而且路由器定期叫唤路由信息的成本也会更高昂，网络性能因此变差（因为很多操作都是基于路由表的）。
- 两级的 ip 不够灵活：比如一个单位需要在一个新地点新增一个网络，但是申请到 IP 之前无法上网。两级的 ip 不能让灵活的新增本单位网络。

因为这些不合理的地方，就诞生了划分子网，基本思路：

1.

### CIDR/构造超网

## IP 地址和硬件地址

物理地址是数据链路层和物理层使用的地址，IP 地址是网络层及以上各层使用的地址，是一种逻辑地址。
![](https://raw.githubusercontent.com/CyC2018/CS-Notes/master/notes/pics/66192382-558b-4b05-a35d-ac4a2b1a9811.jpg)
IP 地址是放在 IP 数据报的首部，而 MAC 地址是放在数据链路层被封装成 MAC 帧。而在转发的过程中，IP 数据报中的源地址和目的地址是不变的，始终是一开始的值。但是物理地址每经过一个 router，原来的 MAC 帧首部和尾部都会被干掉，然后重新添加上新的，此时源地址和目的地址都将改变。

## IP 地址的特点

- IP 地址是一种分等级的地址结构，它有以下好处：
  1.  IP 地址管理机构在分配 IP 地址的时候只分配网络号即可，剩下的网络号单位自行分配。
  2.  路由器仅根据网络号来转发分组，这样可以使得项目数大幅减少，减少了所需资源，提升的速度。
- IP 地址是标志一台主机和一条链路的接口。当一台主机同时连接到两个网络时，则必定有两个不同的 IP 地址，其网络号必定不同。称之为：**多归属主机**。
- 按照互联网的观点，一个网络指的是具有相同网络号的主机的集合，因此使用转发器、网桥连接起来的若干局域网仍然是一个网络。
- 互联网会同等对待每一个 IP 地址。
- 路由器总是有两个及以上的 IP 地址，即路由器的每个接口都有不同的网络号的 IP 地址。
- 两个路由器直接相连的时候，连线的两端可以分配 IP 也可以不分配。如果分配了，则这段连线就构成了只包含一段连线的`特殊“网络”`。如果没有分配 IP，则称这种特殊的网络为**无名网络**或无**编号网络**。

## 为什么有了物理地址还要有 ip 地址？

因为 ip 层存在的原因就是要把异构的网络在上层看来是同一个网络，屏蔽掉底层的差异。ip 地址就是为了统一整个网络主机、路由器的的地址。

要知道，不同的网络主机的硬件地址的格式都不相同，如果要使用硬件地址直接进行通信，那势必要完成地址的转换工作，这项工作是非常复杂的。而 ip 编址把这些差异都屏蔽掉了。

而由 ip 找到对应 mac 地址的工作则由 ARP 完成，高层进程不用考虑这些。

# IP 层转发分组流程

思路：由路由表得知目的网络下一跳路由器的 ip 地址，然后递交给数据链路层接口软件，把下一跳路由器 ip 转换为 mac 并写入 Mac 帧首部，根据这个硬件地址找到下一跳路由器。

分组转发算法：

1.  从数据报首部提取到目的 ip 地址 dst_ip,得出目的网络的网络号 net_id
2.  如果 net_id 和当前 router 在同一局域网，则直接交付（包括 ARP 得出目的主机 Mac 地址，然后封装到 Mac 帧首部最后发送等过程）。
3.  如果能从路由表得出通往目的主机的下一跳 router，则交给下一跳 router；否则看能否得出通往目的网络的下一跳 router。
4.  如果均不能得出下一跳 router，则看是否有默认路由，有给默认 router
5.  没有则报告转发分组错误。

> 至于路由表是怎么得出的见下文。

# IPv6
