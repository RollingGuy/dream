# 地址解析协议ARP
实际应用中，经常遇到：已知一个主机（或路由器）的`IP`地址，需要知道其相应的硬件地址。`ARP`就是解决这个问题的。
![](https://raw.githubusercontent.com/CyC2018/CS-Notes/master/notes/pics/b9d79a5a-e7af-499b-b989-f10483e71b8b.jpg)
> 硬件地址和`IP`地址不存在映射关系。

# ARP高速缓存
主机中都有`ARP`高速缓存 `ARP Cache`，其中存放一个从`IP`地址到硬件地址的映射表，并且它会动态更新，新增、超时删除等。

当`主机A`要向**本局域网**的某台`主机B`发送`ip`数据报时，就先在`ARP Cache`中查看是否有`B`的`ip`地址，如果有则直接就可得出对应的硬件地址，然后通过局域网把对应的`MAC`帧发送到这个硬件地址即可。

如果查不到，则主机会运行`ARP`，找出`B`的硬件地址：
1.  `ARP`进程在本局域网上广播一个`ARP`请求分组，分组的主要内容意思就是：我的`ip`、硬件地址是多少，我想知道`ip`为`x`的硬件地址
2.  在本局域网上所有主机上运行的`ARP`进程都会收到这个请求分组
3.  如果某个主机的`ip`地址就是请求分组中给出的`ip`，则收下`ARP`请求分组，并向A发送`ARP`响应分组，在这个分组中写入自己的物理地址。
4.  其他主机因为自己的`ip`跟请求分组中的`ip`不同，直接丢弃这个`ARP`请求分组即可
5. 得到B的物理地址后，`A`就将其写入`ARP cache`中。（`B`也会把`A`的`ip`-物理地址写入自己的`ARP cache`中）。
> 这样就得到了`B`的物理地址，不过`ARP`只能得出同一局域网的。`ARP`请求分组是广播发送的，但是`ARP`响应分组是普通的单播。

`ARP`仅仅是解决在同一局域网上的主机或路由器的`IP`和硬件地址的映射问题。`ARP`对保存在高速缓存中的映射都会设置生存时间，超过生存时间的`item`会从缓存中干掉，这保证了`ARP`不会因为某个主机硬件地址的改变而无法和其通信的问题。

# ARP解析硬件地址全过程
![](https://raw.githubusercontent.com/CyC2018/CS-Notes/master/notes/pics/8006a450-6c2f-498c-a928-c927f758b1d0.png)
1.  `h1`要将`ip`数据报发送到同一个网络的另一台主机`h2`。`h1`发送`ARP`请求分组得到`h2`的物理地址。
2.  `h1`要将`ip`数据报发送到不同网络的`h3`.这时`h1`发送`ARP`请求，找到当前网络的一个`router1`，然后把数据发送给`router1`
3.  `router1`如果发现`h3`跟自己在同一个局域网，则通过`ARP`请求得到其`MAC`地址，然后发送。
4.  否则，`router1`找到下一个网络的一个`router2`，把数据交给`router2`
5.  `router2`重复上述工作，直到某个`router`跟`h3`在同一个网络，交付到`h3`即可。
