# TCP概述

## TCP的特点
1.  面向连接：应用程序在使用`TCP`协议之前必须要先建立`TCP`连接，在传送数据完毕之后必须释放已经建立的`TCP`连接。
2.  点对点：`TCP`不像`UDP`那样支持多(一)对多（一）的连接，每一条连接只能由两个端点。
3.  提供可靠交付：通过`TCP`连接传送的数据，无差错、不丢失、不重复，按序到达。
4.  提供全双工通信：也就是说通信双方的应用进程可以在任意时刻发送数据。两端都设有**发送缓存**、**接受缓存**，来临时存放双向通信的数据。
5.  面向字节流：流，就是流入到进程或者从进程流出的字节序列。面向字节流就是说：虽然应用程序和`TCP`的交互是一次一个数据块（大小每次都不一样），但是`TCP`将应用程序交付下来的数据仅仅看做是一连串无结构的字节流，`TCP`并不知道所传输的字节流的含义。

> `TCP`不保证接收方应用程序收到的数据块和发送方应用程序所放出的数据块具有对应大小关系。（因为`TCP`会自行决定发送的数据块的大小）。但是接受方的应用程序必须有能力能够识别收到的字节流，并把他还原为有意义的应用层数据。
>> 另外，还有一点需要注意，`TCP`或者说运输层所提供的是一条逻辑连接，并不是一条真正的物理连接，`TCP`的报文还要传送到IP层加上`IP`首部再传送至数据链路层、物理层才发送到物理链路的。

## TCP的连接
每一条`TCP`只能是端对端的，`TCP`连接的端点叫做**套接字（socket）**。

格局RFC793的定义，套接字就是：端口拼接到IP地址后，`ip:port`

> 每一条`TCP`连接唯一地被两个`socket`所确定。同一个IP可以有多个不同的`TCP`连接，同一个端口也能出现在多个不同的`TCP`连接中。

# TCP的首部
`TCP`是面向字节流的，但是`TCP`传送的数据单元却是报文段。报文段分为：首部和数据两部分，而`TCP`的全部功能都体现在它的首部中的各字段中。

`TCP`报文段首部的前`20byte`是固定的，后面有4nbyte是根据需要增加的**选项**，因此`TCP`报文首部的最小长度为20byte。

![](https://user-gold-cdn.xitu.io/2019/4/25/16a53feab312bdb3?w=1460&h=1006&f=png&s=2491766)

首部固定部分各个字段：

1.  源端口、目的端口：各占`2byte`。
2.  序号（Seq）：`4byte`，范围是`0 ~ 2^32 - 1`。`TCP`连接中每一个字节都是按顺序编号的，这个字段中的值就是此次发送报文段**数据**的第一个字节的序号。
3.  确认号（Ack）：`4byte`，期望对方下一个报文段的第一个数据字节的序号，意义是告诉对方，`Ack`之前（不包括`Ack`）的数据都收到了。
4.  数据偏移：`4byte`，就是`TCP`报文段首部的长度（因为除了固定的`20byte`还有`4n byte`的选项）。意义为：从数据起始处距离报文起始处有多远。数据偏移的单位是`32byte`长的字，`4byte`能表示的范围就是`0~15`个字，也就是`0~60byte`，所以`TCP`首部的最大长度为`60byte`，选项长度最大为`40个byte`。
5.  保留：`6byte`，保留今后使用，目前置`0`.
6.  6个控制位：
    1.  紧急URG：`URG=1`时，表示紧急指针字段有效
    2.  确认ACK：仅当`ACK=1`时**确认号**字段才有效，请注意区分确认号跟确认控制位的区别。`ACK=0`时确认号无效，而且`TCP`规定，在连接建立之后每次传送数据时，报文段的`ACK`都必须是1.
    3.  推送PSH：因为`TCP`对应用程序交付的字节流不会立即发送，而是放入发送缓存，等到合适的时候才发送出去，如果应用程序需要立刻发送，可以将`PSH=1`，这时`TCP`会立即创建一个报文段发送出去；接收方`TCP`在收到`PSH=1`的报文段后，就尽快的交付给应用程序，而不是等到整个接受缓存都填满才交付给应用程序。（很少使用）
    4.  复位RST：`RST=1`，表示`TCP`连接出现严重差错，需要断开连接重新连接。`RST=1`还可以拒绝打开一个连接或者拒绝一个非法的报文段。
    5.  同步SYN：`SYN=1`表示请求建立连接或者同意建立连接，也就是说这个报文是个连接请求或连接接受报文。
    6.  终止FIN：释放一个连接，`FIN=1`，表示此报文段的放松放的数据已经发送完毕，请求释放运输连接。
7.  窗口：`2byte`。指当前报文段发送方的**接受窗口**，告诉对方我还能允许对方发送多少数据（`byte`）。窗口能够作为对方设置其发送窗口大小的依据。
8.  检验和：`2byte`。和`UDP`一样，只不过在加`12byte`伪首部时，长度换位`TCP`报文的长度，协议号由17改为6.如果是`Ipv6`，则相应的伪首部也要改变。
9.  紧急指针：配合`URG=1`使用，`2byte`。指明紧急数据的末尾在报文段中的位置，也就是紧急数据的长度（因为，紧急数据完了才是正常数据）。
10. 选项：最长`40byte`。

## 选项
起初，`TCP`只规定了一个选项：最大报文段长度`（MSS, Maximum Segment Size）`,每一个`TCP`数据字段的最大长度。

要传送的数据至少要加上`TCP`的`20byte`首部和IP的`20byte`首部，如果`MSS`较小，那么首部相对长度就会非常长降低效率；反之如果`MSS`过大，在`IP`分片，每个分片都得有`IP`首部，依然降低了效率。而且这些分片出错重传、接收方将分片装配为原先的报文等都需要耗费资源。

所以在不分片的前提下，`MSS`应尽可能的大一些。

但是，`MSS`不是固定不变的，不同路径的`MSS`是不一样的，所以在连接建立的时候，双方都讲自己能够支持的`MSS`写入选项字段中，以后就按照这个数来，`MSS`默认为`556byte`。

随着`Internet`的发展，又新增了多个选项字段：
+ 窗口扩大选项：`3byte`，其中`1byte`表示移位值`S`，`S`最大可取`14`，所以窗口的最大值为`2^(16 + 14) - 1`
> 如果不需要扩大，`S`置为0就能使窗口大小回到`2^16`。
+ 时间戳选项：`10byte`。最主要的字段是时间戳值字段(`4byte`)和时间戳回送回答字段（`4byte`）。
  作用：①计算`RTT`。②处理`TCP`序号`Seq`超过`2^32`的情况，也就是*防止序号绕回PAWS*。

# TCP的可靠传输
