# 概述
`FTP`：`File Transfer Protocol` 文件传输协议。基于`TCP`。

其端口为`21`.

想要在网络环境中将一个文件传输到另一台计算机上，面临的问题有很多：
+ 不同操作系统的目录结构、目录命名规则、文件命名规则不同
+ 存储格式不同
+ 对于相同文件存取功能，命令不同
+ 访问控制方法不同
> 而`FTP`要解决的就是减少或消除在不同OS下处理file的不兼容性。

# 基本原理
`FTP`使用`CS`模式，一个`server`可以同时为多个`client`提供服务。`FTP`的`server`由两大部分组成：
+ 主进程：负责接收新的请求
+ 从属进程：可能有多个，用于处理单个请求。

而且FTP的连接是基于两条`TCP`连接的，分别对应：控制连接、数据连接。
> 前者用于发送控制指令，后者用于真正的数据传输。

## 控制连接的建立
+ `server`打开21端口等待`client`的请求
+ `client`发送建立连接请求到`server`的`21`端口
+ `server`接受请求，创建控制进程，建立控制连接

## 数据连接的建立
根据数据连接建立的主被动不同，可以将FTP分为两种模式：
+ 主动模式：`server`主动和`client`建立数据连接
+ 被动模式：`client`主动（`server`被动）和`server`建立数据连接
> 主动模式下的数据连接，`server`所使用的端口的`20`.

### 主动模式
`server`通过控制连接得到`client`的另一端口后，用自己的`20`端口主动发起`TCP`连接，与`client`建立数据连接。

### 被动模式
被动模式下，`server`监听`1024~65535`之间的一个随机端口，通过控制连接告诉`client`，随后`client`主动发起`TCP`连接，和`server`建立数据连接。

## 完整过程
+ `server`打开`21`端口等待`client`的请求
+ `client`发起连接请求
+ `server`的主进程收到连接建立请求后，创建控制进程。`server`和`client`的控制进程建立控制连接

若是主动模式：
+ 等到`client`想要进行文件传输操作时，`client`发送文件传输请求，并将其另一端口号写入请求报文中
+ `server`主动发起`TCP`连接，与`client`建立数据连接
+ 传送文件完毕后，关闭数据连接

若是被动模式：
+ `server`监听`1024~65535`的一个随机端口，并通过控制连接告诉`client`这个端口
+ 等到`client`想要进行文件传输操作时，就发起`TCP`连接，与`server`建立数据连接
+ 传送文件完毕后，关闭数据连接

> 可以看到，控制连接在整个会话过程都是存在的，而数据连接仅仅在开始文件传送时才创建。

# 为什么需要建立两个TCP连接？
网上的说法五花八门，我看到最觉得靠谱的是：

使用两个`socket`可以在传输文件的同时，发送控制信息。因为很有可能文件很大，但是传送了一般我就不想传了。这个时候可以发送`ctl + c`来中断传输。

也就是说，两个`TCP`连接能够对数据的传输做一些控制。

# 为什么会有主动、被动模式？
早先的互联网主机很少，大部分都采用的是主动模式，server还吃得消。后来规模太大，如果全部都采用主动模式，那server的负荷太大。

而且还有一个问题，那就是如果client处于私网，这个时候server是无法访问client的，也就无从建立数据连接了。

而在主动模式不适用的情形（比如上述2个），被动模式就能够很好的解决。
> 还有一些情况，比如server不支持主动模式、client的某个端口被防火墙给禁掉等等。

# 简单文件传输协议TFTP
`TFTP`是基于`UDP`的，它只能文件传输而不能交互。其端口号为`69`.

主要特点：
+ 每次传送的数据报有`512byte`，最后一次可以少于这个数
+ 每次发送的报文都会按序编号，从1开始
+ 发送完一个数据报之后需要等待确认报文，收到确认之后再发送下一个，否则超时重传

> `TFTP`结束的标志是最后一个报文的大小是否小于`512,`如果总数据刚好是`512`的整数倍，则最后还需要发送一个只含首部不含数据部分的报文。


## 优点
因为基于`UDP`，所以占用资源少、可以同时向多个机器提供文件传输服务（`UDP`所有的特点嘛）。


# 参考

[FTP的两种传输模式](https://zhuanlan.zhihu.com/p/37963548)

[ftp实现原理以及抓包分析](https://www.jianshu.com/p/05212313d0e2)